<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#6366f1">
  <title>Talking Robot V2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
  <style>
:root {
  --bg: #f0f4ff;
  --bg-grad: linear-gradient(135deg, #e0e7ff, #f0f4ff, #fdf2f8);
  --panel: #ffffff;
  --card: #ffffff;
  --accent: #22c55e;
  --accent-soft: rgba(34,197,94,0.15);
  --primary: #6366f1;
  --primary-soft: rgba(99,102,241,0.15);
  --secondary: #f472b6;
  --warning: #f59e0b;
  --danger: #ef4444;
  --text: #1e293b;
  --muted: #64748b;
  --border: rgba(99,102,241,0.2);
  --radius: 16px;
  --font: 'Fredoka', sans-serif;
  --mono: 'JetBrains Mono', monospace;
}
[data-theme="dark"] {
  --bg: #0a1628;
  --bg-grad: radial-gradient(circle at 20% 20%, rgba(99,102,241,0.15), transparent 50%), radial-gradient(circle at 80% 80%, rgba(244,114,182,0.1), transparent 50%), #0a1628;
  --panel: #0f172a;
  --card: #1e293b;
  --text: #f1f5f9;
  --muted: #94a3b8;
  --border: rgba(148,163,184,0.2);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  min-height: 100vh;
  min-height: 100dvh;
  background: var(--bg-grad);
  background-attachment: fixed;
  color: var(--text);
  font-family: var(--font);
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
}
.skip-link { position: absolute; top: -100px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: var(--primary); color: white; border-radius: 8px; z-index: 9999; text-decoration: none; font-weight: 600; }
.skip-link:focus { top: 10px; }
.app { display: flex; flex-direction: column; min-height: 100vh; min-height: 100dvh; }

/* Header */
.header {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  display: grid; grid-template-columns: auto 1fr auto;
  align-items: center; gap: 16px;
  padding: 12px 20px; background: var(--panel);
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  transition: left 0.3s ease, right 0.3s ease;
}
.header-left { display: flex; align-items: center; }
.logo { 
  width: 80px; height: 80px; 
  filter: drop-shadow(0 4px 16px rgba(0, 123, 255, 0.5)); 
  animation: logoPulse 3s ease-in-out infinite;
}
@keyframes logoPulse { 
  0%, 100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 4px 16px rgba(0, 123, 255, 0.5)); } 
  50% { transform: scale(1.08) rotate(2deg); filter: drop-shadow(0 8px 24px rgba(0, 123, 255, 0.7)); } 
}
.header-center { 
  display: flex; flex-direction: column; align-items: center; 
  justify-self: center;
}
.app-title {
  font-size: 2.2rem; font-weight: 800;
  background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
  background-size: 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 6s linear infinite;
  text-align: center;
  letter-spacing: -0.5px;
}
@keyframes shimmer { 0%,100%{background-position:0 50%} 50%{background-position:100% 50%} }
.app-subtitle { font-size: 1rem; color: var(--muted); text-align: center; font-weight: 500; }
.header-right { display: flex; align-items: center; gap: 8px; }
.badge {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 12px; border-radius: 999px;
  font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
  border: 2px solid var(--border); background: var(--panel);
  color: var(--muted); cursor: pointer; transition: all 0.2s;
}
.badge:hover { border-color: var(--primary); }
.badge.connected { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
.badge.groq { border-color: var(--warning); color: var(--warning); }
.badge.gemini { border-color: var(--primary); color: var(--primary); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1; transform: scale(1);} 50%{opacity:0.5; transform: scale(0.9);} }
.btn-icon {
  width: 40px; height: 40px; border-radius: 10px;
  border: 2px solid var(--border); background: var(--panel);
  color: var(--text); font-size: 1.1rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.btn-icon:hover { border-color: var(--primary); background: var(--primary-soft); transform: translateY(-1px); }
.btn-icon.active { border-color: var(--primary); background: var(--primary); color: white; }

/* Mobile header adjustments */
@media (max-width: 600px) {
  .logo { width: 56px; height: 56px; }
  .app-title { font-size: 1.5rem; }
  .app-subtitle { font-size: 0.8rem; }
  .badge { display: none; }
}

/* Main */
.main { flex: 1; padding: 115px 16px 140px; display: flex; flex-direction: column; align-items: center; transition: margin-left 0.3s ease, margin-right 0.3s ease; }

/* Desktop: Push layout when logs open */
@media (min-width: 900px) {
  body.logs-open .main { margin-right: 400px; }
  body.logs-open .header { right: 400px; }
  body.logs-open .input-area { right: 400px; }
}

/* Robot Avatar */
.robot-section { display: flex; flex-direction: column; align-items: center; padding: 20px; }
.robot-wrapper { position: relative; }
.robot-body {
  width: min(280px, 70vw); height: min(280px, 70vw);
  background: linear-gradient(145deg, var(--card), var(--panel));
  border-radius: 28px; border: 4px solid var(--border);
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 24px;
  box-shadow: 0 20px 60px rgba(99,102,241,0.15);
  transition: all 0.3s; position: relative;
}
.robot-body::before {
  content: ''; position: absolute; inset: -4px; border-radius: 32px;
  background: transparent; transition: all 0.3s; z-index: -1;
}
.robot-body.listening { border-color: var(--primary); }
.robot-body.listening::before { background: var(--primary); filter: blur(20px); opacity: 0.3; }
.robot-body.thinking { border-color: var(--warning); }
.robot-body.thinking::before { background: var(--warning); filter: blur(20px); opacity: 0.3; }
.robot-body.speaking { border-color: var(--accent); }
.robot-body.speaking::before { background: var(--accent); filter: blur(20px); opacity: 0.3; }
.robot-antenna {
  position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
  width: 4px; height: 24px; background: var(--border); border-radius: 2px;
}
.robot-antenna::after {
  content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
  width: 14px; height: 14px; background: var(--primary); border-radius: 50%;
  box-shadow: 0 0 12px var(--primary); animation: pulse 2s infinite;
}
.robot-body.listening .robot-antenna::after { background: var(--primary); animation: blink 0.5s infinite; }
.robot-body.thinking .robot-antenna::after { background: var(--warning); }
.robot-body.speaking .robot-antenna::after { background: var(--accent); }
.robot-eyes { display: flex; gap: 40px; padding-top: 20px; }
.robot-eye {
  width: 52px; height: 52px; background: var(--primary); border-radius: 12px;
  box-shadow: 0 0 20px rgba(99,102,241,0.5), inset 0 -6px 12px rgba(0,0,0,0.2);
  transition: all 0.2s; position: relative;
}
.robot-eye::before {
  content: ''; position: absolute; top: 8px; left: 8px;
  width: 16px; height: 16px; background: rgba(255,255,255,0.5); border-radius: 50%;
}
.robot-body.listening .robot-eye { animation: blink 0.4s infinite alternate; }
.robot-body.thinking .robot-eye { background: var(--warning); box-shadow: 0 0 20px rgba(245,158,11,0.5); animation: think 1s infinite; }
.robot-body.speaking .robot-eye { background: var(--accent); box-shadow: 0 0 20px rgba(34,197,94,0.5); }
@keyframes blink { 0%{transform:scaleY(1)} 100%{transform:scaleY(0.2); border-radius: 50%;} }
@keyframes think { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
.robot-mouth {
  width: 80px; height: 24px; background: var(--card);
  border: 3px solid var(--border); border-radius: 999px;
  overflow: hidden; position: relative;
}
.robot-mouth-inner {
  position: absolute; bottom: 0; left: 0; right: 0; height: 0%;
  background: linear-gradient(to top, var(--accent), var(--primary));
  transition: height 0.1s; border-radius: 999px;
}
.robot-body.speaking .robot-mouth-inner { animation: speak 0.15s infinite alternate; }
@keyframes speak { 0%{height:20%} 100%{height:90%} }
.robot-body:not(.listening):not(.thinking):not(.speaking) .robot-mouth {
  border-radius: 0 0 40px 40px; border-top: none; height: 20px;
}
.robot-body:not(.listening):not(.thinking):not(.speaking) .robot-mouth-inner {
  height: 100%; background: var(--accent);
}
.robot-status {
  margin-top: 24px; padding: 10px 24px; background: var(--panel);
  border: 2px solid var(--border); border-radius: 999px;
  font-size: 0.85rem; font-weight: 600; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.05em;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  transition: all 0.3s;
}
.robot-body.listening ~ .robot-status { color: var(--primary); border-color: var(--primary); }
.robot-body.thinking ~ .robot-status { color: var(--warning); border-color: var(--warning); }
.robot-body.speaking ~ .robot-status { color: var(--accent); border-color: var(--accent); }

/* Microbit Widget */
.microbit-widget {
  margin-top: 30px; padding: 16px; background: var(--card);
  border-radius: var(--radius); border: 2px solid var(--border);
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.microbit-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
.microbit-title { font-size: 0.75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; }
.microbit-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
.microbit-dot.on { background: var(--accent); animation: pulse 2s infinite; }
.led-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 4px; padding: 8px; background: #1a1a2e; border-radius: 8px; }
.led-pixel { aspect-ratio: 1; background: #2a2a4a; border-radius: 2px; transition: all 0.1s; }
.led-pixel.on { background: #ff6b6b; box-shadow: 0 0 8px #ff6b6b; }

/* Chat */
.chat-section { 
  width: 100%; 
  max-width: 500px; 
  padding: 16px;
  background: var(--card);
  border-radius: var(--radius);
  border: 2px solid var(--border);
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  margin-top: 20px;
}
.chat-header {
  display: flex; align-items: center; justify-content: space-between;
  padding-bottom: 12px; margin-bottom: 12px;
  border-bottom: 1px solid var(--border);
}
.chat-header-title {
  font-size: 0.8rem; font-weight: 600; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.05em;
  display: flex; align-items: center; gap: 8px;
}
.chat-container {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 10px;
  font-family: var(--mono);
  font-size: 0.75rem;
  background: var(--bg);
  border-radius: 12px;
  max-height: 300px;
  overflow-y: auto;
}
.chat-bubble {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 12px 16px; border-radius: var(--radius);
  animation: bubbleIn 0.3s ease-out; max-width: 85%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
@keyframes bubbleIn { from{opacity:0;transform:translateY(10px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }
.chat-bubble.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
.chat-bubble.robot { align-self: flex-start; background: var(--card); border: 2px solid var(--border); border-bottom-left-radius: 4px; }
.chat-bubble .avatar { font-size: 1.2rem; flex-shrink: 0; }
.chat-bubble .content { flex: 1; min-width: 0; }
.chat-bubble .text { font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; }
.chat-bubble .time { font-size: 0.65rem; opacity: 0.7; margin-top: 4px; }
.typing-indicator { display: flex; align-items: center; gap: 4px; padding: 12px 16px; background: var(--panel); border: 2px solid var(--border); border-radius: var(--radius); width: fit-content; margin: 10px; }
.typing-dot { width: 8px; height: 8px; background: var(--muted); border-radius: 50%; animation: typing 1.4s infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-8px)} }
.chat-actions { display: flex; justify-content: flex-end; }
.btn-clear { padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel); color: var(--muted); font-size: 0.7rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-clear:hover { color: var(--danger); border-color: var(--danger); background: rgba(239,68,68,0.1); }
.hidden { display: none !important; }

/* Input Area */
.input-area {
  position: fixed; bottom: 0; left: 0; right: 0;
  padding: 16px; padding-bottom: max(16px, env(safe-area-inset-bottom));
  background: var(--panel);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  z-index: 90;
  transition: left 0.3s ease, right 0.3s ease;
}
.input-row { display: flex; gap: 12px; align-items: center; max-width: 600px; margin: 0 auto; }
.text-input {
  flex: 1; padding: 14px 20px; border-radius: 999px;
  border: 2px solid var(--border); background: var(--card);
  color: var(--text); font-family: var(--font); font-size: 1rem; outline: none;
  transition: all 0.2s;
}
.text-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-soft); }
.text-input::placeholder { color: var(--muted); }
.btn-action {
  width: 56px; height: 56px; border-radius: 50%; border: none;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem; transition: all 0.2s; flex-shrink: 0;
  position: relative; overflow: hidden;
}
.btn-action::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(rgba(255,255,255,0.2), transparent);
  border-radius: inherit;
}
.btn-mic { background: linear-gradient(145deg, var(--primary), #4f46e5); color: white; box-shadow: 0 8px 24px rgba(99,102,241,0.4); }
.btn-mic:hover { transform: scale(1.08); box-shadow: 0 12px 32px rgba(99,102,241,0.5); }
.btn-mic:active { transform: scale(0.95); }
.btn-mic.active { background: linear-gradient(145deg, var(--danger), #dc2626); box-shadow: 0 8px 24px rgba(239,68,68,0.4); }
.btn-mic.active::after {
  content: ''; position: absolute; inset: -4px;
  border: 3px solid var(--danger); border-radius: 50%;
  animation: micPulse 1s infinite;
}
@keyframes micPulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.15);opacity:0} }
.btn-send { background: linear-gradient(145deg, var(--accent), #16a34a); color: white; box-shadow: 0 8px 24px rgba(34,197,94,0.4); }
.btn-send:hover { transform: scale(1.08); box-shadow: 0 12px 32px rgba(34,197,94,0.5); }
.btn-send:active { transform: scale(0.95); }

/* Overlay & Sidebar */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150; backdrop-filter: blur(2px); }
.overlay.show { display: block; }
.sidebar {
  position: fixed; top: 0; right: 0; bottom: 0; width: 340px; min-width: 280px; max-width: 90vw;
  background: var(--panel); border-left: 1px solid var(--border);
  z-index: 200; transform: translateX(100%); transition: transform 0.3s ease;
  display: flex; flex-direction: column;
}
.sidebar.open { transform: translateX(0); }
.sidebar.resizing { transition: none; user-select: none; }
.sidebar-resize-handle {
  position: absolute; left: -5px; top: 0; bottom: 0; width: 10px;
  cursor: ew-resize; z-index: 10;
}
.sidebar-resize-handle::before {
  content: ''; position: absolute; left: 4px; top: 50%; transform: translateY(-50%);
  width: 3px; height: 40px; background: var(--border); border-radius: 2px;
  opacity: 0; transition: opacity 0.2s;
}
.sidebar-resize-handle:hover::before, .sidebar.resizing .sidebar-resize-handle::before { opacity: 1; }
.sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 1rem; }
.btn-close { width: 36px; height: 36px; border-radius: 8px; border: none; background: var(--card); color: var(--text); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.btn-close:hover { background: var(--danger); color: white; }
.sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
.settings-section { margin-bottom: 24px; }
.section-title { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
.lang-grid, .provider-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
.lang-btn, .provider-btn {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  padding: 14px 8px; border-radius: 12px; border: 2px solid var(--border);
  background: var(--card); cursor: pointer; transition: all 0.2s;
}
.lang-btn:hover, .provider-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
.lang-btn.active { border-color: var(--accent); background: var(--accent-soft); }
.provider-btn.active { border-color: var(--primary); background: var(--primary-soft); }
.lang-btn .flag, .provider-btn .icon { font-size: 1.8rem; }
.lang-btn .name, .provider-btn .name { font-size: 0.7rem; font-weight: 600; color: var(--muted); }
.lang-btn.active .name { color: var(--accent); }
.provider-btn.active .name { color: var(--primary); }
.api-input {
  width: 100%; padding: 12px 16px; border-radius: 10px;
  border: 2px solid var(--border); background: var(--card);
  color: var(--text); font-family: var(--mono); font-size: 0.85rem; outline: none;
  transition: all 0.2s;
}
.api-input:focus { border-color: var(--primary); }
.api-hint { font-size: 0.7rem; color: var(--muted); margin-top: 8px; }
.api-hint a { color: var(--primary); text-decoration: none; }
.api-hint a:hover { text-decoration: underline; }
.voice-row { display: flex; gap: 12px; margin-bottom: 12px; }
.voice-select { flex: 1; padding: 12px; border-radius: 10px; border: 2px solid var(--border); background: var(--card); color: var(--text); font-size: 0.85rem; cursor: pointer; }
.voice-select:focus { border-color: var(--primary); outline: none; }
.btn-test { padding: 12px 16px; border-radius: 10px; border: 2px solid var(--border); background: var(--card); color: var(--text); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.btn-test:hover { border-color: var(--primary); background: var(--primary-soft); }
.speed-row { display: flex; align-items: center; gap: 12px; }
.speed-slider { flex: 1; height: 8px; border-radius: 4px; background: var(--border); appearance: none; -webkit-appearance: none; cursor: pointer; }
.speed-slider::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: var(--primary); cursor: pointer; box-shadow: 0 2px 8px rgba(99,102,241,0.4); }
.speed-slider::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; background: var(--primary); cursor: pointer; border: none; }
.speed-value { min-width: 50px; text-align: center; font-weight: 600; color: var(--primary); }
.toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--card); border-radius: 10px; border: 1px solid var(--border); margin-bottom: 8px; }
.toggle-info .title { font-size: 0.9rem; font-weight: 600; }
.toggle-info .desc { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }
.toggle { position: relative; width: 48px; height: 26px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; inset: 0; background: var(--border); border-radius: 999px; cursor: pointer; transition: 0.3s; }
.toggle-slider::before { content: ''; position: absolute; width: 20px; height: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.toggle input:checked + .toggle-slider { background: var(--accent); }
.toggle input:checked + .toggle-slider::before { transform: translateX(22px); }
.personality-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
.personality-btn { display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 10px; border: 2px solid var(--border); background: var(--card); cursor: pointer; transition: all 0.2s; text-align: left; }
.personality-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
.personality-btn.active { border-color: var(--secondary); background: rgba(244,114,182,0.1); }
.personality-btn .p-icon { font-size: 1.5rem; flex-shrink: 0; }
.personality-btn .p-name { font-size: 0.8rem; font-weight: 600; }
.personality-btn .p-desc { font-size: 0.65rem; color: var(--muted); }
.name-input { width: 100%; padding: 12px 16px; border-radius: 10px; border: 2px solid var(--border); background: var(--card); color: var(--text); font-family: var(--font); font-size: 0.9rem; outline: none; margin-bottom: 12px; transition: all 0.2s; }
.name-input:focus { border-color: var(--secondary); }
.input-label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--muted); margin-bottom: 6px; }
.danger-zone { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; padding: 16px; }
.danger-zone .section-title { color: var(--danger); }
.btn-danger { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--danger); background: transparent; color: var(--danger); font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
.btn-danger:hover { background: var(--danger); color: white; }

/* Logs Panel */
.logs-panel {
  position: fixed; top: 0; right: 0; bottom: 0; width: 400px; min-width: 280px; max-width: 90vw;
  background: var(--panel); border-left: 1px solid var(--border);
  z-index: 180; transform: translateX(100%); transition: transform 0.3s ease;
  display: flex; flex-direction: column;
}
.logs-panel.open { transform: translateX(0); }
.logs-panel.resizing { transition: none; user-select: none; }
.logs-resize-handle {
  position: absolute; left: -5px; top: 0; bottom: 0; width: 10px;
  cursor: ew-resize; z-index: 10;
}
.logs-resize-handle::before {
  content: ''; position: absolute; left: 4px; top: 50%; transform: translateY(-50%);
  width: 3px; height: 40px; background: var(--border); border-radius: 2px;
  opacity: 0; transition: opacity 0.2s;
}
.logs-resize-handle:hover::before, .logs-panel.resizing .logs-resize-handle::before { opacity: 1; }
.logs-header { 
  display: flex; align-items: center; justify-content: space-between; 
  padding: 12px 16px; border-bottom: 1px solid var(--border); 
  font-weight: 600; font-size: 0.9rem;
}
.logs-title { display: flex; align-items: center; gap: 8px; }
.logs-toolbar { display: flex; gap: 6px; }
.logs-toolbar button {
  padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border);
  background: var(--card); color: var(--text); font-size: 0.7rem;
  cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px;
}
.logs-toolbar button:hover { border-color: var(--primary); background: var(--primary-soft); }
.logs-toolbar button.danger:hover { border-color: var(--danger); background: rgba(239,68,68,0.1); color: var(--danger); }
.logs-stats {
  display: flex; gap: 12px; padding: 8px 16px; border-bottom: 1px solid var(--border);
  font-size: 0.7rem; color: var(--muted); background: var(--bg);
}
.logs-stat { display: flex; align-items: center; gap: 4px; }
.logs-stat-value { font-weight: 600; color: var(--text); }
.logs-filter {
  display: flex; gap: 6px; padding: 8px 16px; border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.logs-filter-btn {
  padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border);
  background: var(--card); color: var(--muted); font-size: 0.65rem;
  cursor: pointer; transition: all 0.2s; text-transform: uppercase; font-weight: 600;
}
.logs-filter-btn:hover { border-color: var(--primary); }
.logs-filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
.logs-content { flex: 1; overflow-y: auto; padding: 12px; background: var(--bg); font-family: var(--mono); font-size: 0.75rem; line-height: 1.6; }
.logs-content.filtered-tx .log-entry:not(.tx) { display: none; }
.logs-content.filtered-rx .log-entry:not(.rx) { display: none; }
.logs-content.filtered-error .log-entry:not(.error) { display: none; }
.logs-content.filtered-ai .log-entry:not(.ai) { display: none; }
.logs-content.filtered-ble .log-entry:not(.tx):not(.rx):not(.ble) { display: none; }
.logs-content.filtered-speech .log-entry:not(.speech) { display: none; }
.log-entry { padding: 4px 8px; margin-bottom: 4px; border-radius: 4px; word-break: break-word; }
.log-entry.tx { background: rgba(244,114,182,0.1); border-left: 3px solid var(--secondary); }
.log-entry.rx { background: rgba(34,211,238,0.1); border-left: 3px solid #22d3ee; }
.log-entry.ble { background: rgba(139,92,246,0.1); border-left: 3px solid #a78bfa; }
.log-entry.speech { background: rgba(245,158,11,0.1); border-left: 3px solid var(--warning); }
.log-entry.ai { background: rgba(34,197,94,0.1); border-left: 3px solid var(--accent); }
.log-entry.success { color: var(--accent); }
.log-entry.error { background: rgba(239,68,68,0.1); border-left: 3px solid var(--danger); color: var(--danger); }
.log-tag { padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; font-weight: 700; text-transform: uppercase; margin-right: 6px; }
.log-tag.ble { background: rgba(139,92,246,0.2); color: #a78bfa; }
.log-tag.speech { background: rgba(245,158,11,0.2); color: var(--warning); }
.log-tag.ai { background: var(--accent-soft); color: var(--accent); }
.log-tag.error { background: rgba(239,68,68,0.2); color: var(--danger); }
.logs-empty { text-align: center; color: var(--muted); padding: 40px 20px; font-family: var(--font); }

/* Commands Panel */
.commands-panel {
  position: fixed; top: 0; left: 0; bottom: 0; width: 320px; min-width: 250px; max-width: 90vw;
  background: var(--panel); border-right: 1px solid var(--border);
  z-index: 180; transform: translateX(-100%); transition: transform 0.3s ease;
  display: flex; flex-direction: column;
}
.commands-panel.open { transform: translateX(0); }
.commands-panel-header { 
  display: flex; align-items: center; justify-content: space-between; 
  padding: 12px 16px; border-bottom: 1px solid var(--border); 
  font-weight: 600; font-size: 0.9rem;
}
.commands-panel-content { 
  flex: 1; overflow-y: auto; padding: 12px;
}
.commands-panel-content .command-category { margin-bottom: 10px; }
.commands-panel-content .category-commands { 
  display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 5px; padding: 10px; 
}

/* Desktop: Push layout when commands open */
@media (min-width: 900px) {
  body.commands-open .main { margin-left: 320px; }
  body.commands-open .header { left: 320px; }
  body.commands-open .input-area { left: 320px; }
}

/* Modal */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 300; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
.modal.open { display: flex; }
.modal-content { background: var(--panel); border-radius: 20px; border: 1px solid var(--border); max-width: 480px; width: 100%; max-height: 85vh; overflow: hidden; animation: modalIn 0.25s ease-out; }
@keyframes modalIn { from{opacity:0;transform:scale(0.9) translateY(20px)} to{opacity:1;transform:scale(1) translateY(0)} }
.modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 1.1rem; }
.modal-body { padding: 20px; overflow-y: auto; max-height: calc(85vh - 80px); }
.command-category { background: var(--card); border-radius: 12px; margin-bottom: 12px; overflow: hidden; border: 1px solid var(--border); }
.category-header { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: var(--panel); border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.9rem; }
.category-commands { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; padding: 12px; }
.command-chip { padding: 6px 10px; background: var(--primary-soft); border-radius: 6px; font-family: var(--mono); font-size: 0.7rem; color: var(--primary); cursor: pointer; border: none; transition: all 0.2s; }
.command-chip:hover { background: var(--primary); color: white; transform: scale(1.05); }

/* Rate Limit */
.rate-limit { display: none; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 10px; margin: 0 16px 16px; }
.rate-limit.show { display: flex; animation: slideDown 0.3s ease-out; }
@keyframes slideDown { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
.rate-limit-info { flex: 1; }
.rate-limit-title { font-size: 0.8rem; font-weight: 600; color: var(--warning); }

/* Mobile */
@media (max-width: 768px) {
  .app-subtitle { display: none; }
  .header-right .btn-icon:not(:first-child):not(:last-child) { display: none; }
  .sidebar { width: 100%; }
  .robot-body { width: min(240px, 70vw); height: min(240px, 70vw); }
  .robot-eyes { gap: 30px; }
  .robot-eye { width: 42px; height: 42px; }
}
@media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <!-- WDI Logo -->
        <svg class="logo" viewBox="-92.820084 179.975632 6.000000 3.214096" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.26918,180.70665C-90.270096,180.703674,-90.280693,180.55484,-90.292725,180.3759C-90.304756,180.19696,-90.315605,180.042282,-90.316826,180.032166L-90.319046,180.013763L-90.29628,180.013763C-90.283752,180.013748,-90.25869,180.012115,-90.240585,180.010117C-90.222481,180.008118,-90.191841,180.005646,-90.172501,180.004608L-90.137344,180.002731L-90.128738,180.131226C-90.124008,180.201889,-90.119133,180.269699,-90.117897,180.281921L-90.115662,180.304123L-90.05497,180.20639C-90.021591,180.152634,-89.977379,180.08139,-89.956726,180.048065L-89.919182,179.987488L-89.883324,179.985062C-89.863602,179.983734,-89.824806,179.980759,-89.797112,179.978455C-89.769424,179.976166,-89.739342,179.974884,-89.73027,179.975632L-89.713783,179.976974L-89.825653,180.145996L-89.937531,180.315033L-89.796638,180.490601C-89.719147,180.587158,-89.655746,180.667526,-89.655746,180.669174C-89.655746,180.670837,-89.657356,180.672195,-89.659317,180.672195C-89.676155,180.672195,-89.856628,180.684464,-89.861404,180.685928C-89.865883,180.687317,-89.896164,180.651016,-89.971275,180.554199C-90.028305,180.480698,-90.076393,180.421448,-90.07814,180.422516C-90.079887,180.423599,-90.086746,180.433975,-90.093384,180.445587L-90.105461,180.466675L-90.097374,180.581726C-90.091408,180.66658,-90.090439,180.697479,-90.093674,180.699478C-90.099167,180.702866,-90.137032,180.7061,-90.21048,180.709442C-90.257515,180.711578,-90.267807,180.71109,-90.26918,180.70665z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-89.190971,180.7686C-89.267868,180.753281,-89.31105,180.739975,-89.360039,180.716522C-89.393906,180.700302,-89.471527,180.651245,-89.480576,180.640335C-89.484718,180.635345,-89.482971,180.627808,-89.446373,180.493073C-89.44014,180.470108,-89.428429,180.473007,-89.40416,180.50351C-89.35006,180.571503,-89.267303,180.622406,-89.189331,180.635666C-89.152946,180.641846,-89.149734,180.641846,-89.129295,180.635406C-89.09346,180.624115,-89.075447,180.597748,-89.081604,180.565582C-89.085762,180.543793,-89.121902,180.514221,-89.183189,180.482422C-89.254944,180.44519,-89.27681,180.430908,-89.309555,180.399933C-89.365524,180.347,-89.382957,180.291809,-89.367203,180.217453C-89.349838,180.135468,-89.298691,180.084976,-89.207352,180.059616C-89.16906,180.048981,-89.099213,180.048294,-89.053474,180.058105C-88.98037,180.073776,-88.906212,180.104935,-88.843803,180.14621C-88.810745,180.16806,-88.807495,180.171295,-88.809486,180.180176C-88.810699,180.185577,-88.820007,180.220505,-88.830177,180.257782C-88.847977,180.323044,-88.849014,180.325516,-88.858116,180.324509C-88.863312,180.323944,-88.870895,180.31871,-88.874962,180.312897C-88.886063,180.297012,-88.932678,180.252243,-88.951851,180.239044C-89.003326,180.203629,-89.07032,180.181305,-89.113388,180.185211C-89.166359,180.190018,-89.195839,180.22757,-89.177078,180.266357C-89.168106,180.284912,-89.14418,180.302139,-89.078835,180.337082C-88.97522,180.392517,-88.924667,180.434921,-88.900993,180.486298C-88.888092,180.514282,-88.885109,180.566086,-88.894295,180.602661C-88.921547,180.711212,-89.010704,180.773865,-89.135971,180.772491C-89.156639,180.772263,-89.181389,180.770508,-89.190971,180.7686z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-91.104111,180.90361C-91.134857,180.834915,-91.198944,180.691757,-91.246529,180.585495C-91.294121,180.479233,-91.332542,180.391785,-91.331917,180.391159C-91.330269,180.389511,-91.248558,180.352615,-91.135277,180.302368C-91.080956,180.278275,-91.021782,180.253952,-91.003784,180.248306C-90.923584,180.22316,-90.848717,180.234344,-90.799507,180.278824C-90.775833,180.300217,-90.757965,180.329971,-90.742996,180.372955C-90.732986,180.401703,-90.731194,180.412506,-90.731262,180.44368C-90.731339,180.474075,-90.733147,180.485123,-90.741638,180.507187C-90.753166,180.53714,-90.772163,180.572006,-90.780914,180.579269C-90.784096,180.581909,-90.786697,180.585449,-90.786697,180.587128C-90.786697,180.590454,-90.750763,180.609756,-90.581421,180.697388C-90.520706,180.72879,-90.466957,180.757034,-90.461975,180.760147C-90.4533,180.765549,-90.456924,180.767578,-90.547188,180.807983C-90.599037,180.831192,-90.645187,180.85022,-90.64975,180.850266C-90.654312,180.850327,-90.720131,180.816483,-90.796013,180.775055L-90.933975,180.699768L-90.960068,180.711792C-90.974419,180.718399,-90.986549,180.72406,-90.987015,180.72435C-90.987488,180.724655,-90.965302,180.775085,-90.937721,180.836411C-90.910133,180.897751,-90.887093,180.950424,-90.886513,180.953476C-90.885788,180.957291,-90.909706,180.96991,-90.96286,180.993774C-91.005432,181.012878,-91.042053,181.028519,-91.044235,181.028519C-91.046425,181.028519,-91.073364,180.972321,-91.104111,180.90361zM-90.99427,180.585632C-90.928116,180.554184,-90.903168,180.526901,-90.902977,180.485809C-90.902802,180.449066,-90.926598,180.406387,-90.953178,180.395752C-90.982254,180.384109,-91.00518,180.388504,-91.073784,180.418884C-91.095886,180.428665,-91.114441,180.437119,-91.115021,180.437668C-91.116417,180.439011,-91.04142,180.606354,-91.039421,180.606354C-91.038567,180.606354,-91.018242,180.597031,-90.99427,180.585632z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-88.328873,181.18129C-88.367035,181.1548,-88.399017,181.132355,-88.399948,181.131424C-88.400887,181.130493,-88.36216,181.072723,-88.313889,181.003052C-88.265625,180.933365,-88.227539,180.875137,-88.229256,180.873642C-88.232262,180.871017,-88.36467,180.779251,-88.401207,180.754456L-88.418991,180.742401L-88.505783,180.867996C-88.55352,180.937073,-88.594093,180.993607,-88.59594,180.993622C-88.59967,180.993668,-88.741692,180.896652,-88.741692,180.894058C-88.741692,180.892731,-88.562958,180.634018,-88.382385,180.373978C-88.362411,180.345215,-88.344566,180.321136,-88.342712,180.320465C-88.340332,180.319611,-88.229614,180.393921,-88.196304,180.418747C-88.195633,180.41925,-88.226578,180.465042,-88.265076,180.520508C-88.303574,180.575974,-88.335899,180.623642,-88.336906,180.62645C-88.338058,180.629654,-88.30468,180.655014,-88.246178,180.695328C-88.195274,180.730423,-88.152,180.759674,-88.150009,180.76033C-88.148026,180.761002,-88.11441,180.715302,-88.075317,180.658768C-88.036224,180.602249,-88.002808,180.556,-88.00106,180.556C-87.996506,180.556,-87.856689,180.652924,-87.856689,180.656067C-87.856689,180.66153,-88.251923,181.229736,-88.255615,181.229599C-88.257751,181.229523,-88.29071,181.207779,-88.328873,181.18129z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-91.754158,181.531448C-91.888771,181.512161,-92.043076,181.366882,-92.082649,181.222183C-92.093285,181.183273,-92.092499,181.109177,-92.081032,181.069366C-92.049042,180.958313,-91.935387,180.846329,-91.824692,180.816788C-91.785378,180.806305,-91.704155,180.807419,-91.663956,180.818985C-91.603546,180.836395,-91.54142,180.875549,-91.484215,180.932281C-91.430611,180.985458,-91.394707,181.040161,-91.374954,181.098755C-91.364899,181.128601,-91.362389,181.143066,-91.360794,181.18042C-91.358604,181.231888,-91.362877,181.260315,-91.379135,181.302338C-91.403221,181.364624,-91.466469,181.439941,-91.530434,181.482498C-91.598885,181.528046,-91.669739,181.543549,-91.754158,181.531448zM-91.605019,181.363525C-91.545914,181.336853,-91.511971,181.268951,-91.52636,181.206177C-91.548233,181.110733,-91.662498,180.996597,-91.760284,180.972504C-91.805176,180.961456,-91.846542,180.972488,-91.884094,181.005539C-91.904282,181.023315,-91.923706,181.059692,-91.92746,181.086777C-91.935303,181.143326,-91.900101,181.216187,-91.832245,181.283859C-91.751648,181.364258,-91.670021,181.392868,-91.605019,181.363525z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.370827,181.625046C-90.382538,181.620316,-90.390862,181.606598,-90.416695,181.549454C-90.474388,181.421844,-90.474808,181.421082,-90.488495,181.41835C-90.495407,181.416962,-90.549316,181.415833,-90.608307,181.415833L-90.715553,181.415833L-90.723869,181.430634C-90.735786,181.451828,-90.771561,181.484283,-90.794991,181.495132C-90.860039,181.525269,-90.93119,181.512695,-90.977165,181.462952C-90.988503,181.450684,-91.003014,181.430267,-91.009399,181.417587C-91.019745,181.397064,-91.021019,181.390701,-91.021019,181.35968C-91.021019,181.328476,-91.019714,181.322067,-91.008591,181.298569C-90.99292,181.265488,-90.965279,181.238113,-90.930862,181.221588C-90.907669,181.210464,-90.901016,181.209076,-90.869965,181.208862C-90.80793,181.208435,-90.764534,181.22995,-90.732475,181.277023L-90.715042,181.302612L-90.575615,181.304077C-90.436188,181.305527,-90.43618,181.305542,-90.416817,181.31517C-90.398369,181.324356,-90.3964,181.32692,-90.375305,181.369354C-90.363121,181.39386,-90.334541,181.455734,-90.31179,181.506851C-90.28904,181.557983,-90.267876,181.603714,-90.264763,181.60849C-90.253143,181.626328,-90.259285,181.628876,-90.313087,181.628616C-90.340317,181.628479,-90.366295,181.626862,-90.370827,181.625046z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-89.575523,181.72998C-89.576942,181.72856,-89.578293,181.695953,-89.57855,181.657516C-89.578812,181.619064,-89.580498,181.583466,-89.582306,181.578461C-89.585922,181.568417,-89.596901,181.568405,-89.779968,181.578461C-89.864426,181.58309,-89.94313,181.58696,-89.954559,181.587387L-89.975235,181.588165L-89.975525,181.665207C-89.975685,181.707581,-89.97702,181.74604,-89.978491,181.750858C-89.982117,181.762787,-89.991516,181.762192,-89.991135,181.750153C-89.990677,181.735733,-89.981247,181.549591,-89.980011,181.53595C-89.979553,181.530807,-89.984337,181.528473,-90.001167,181.524948C-90.012999,181.522476,-90.030228,181.517761,-90.039383,181.514365C-90.068527,181.50355,-90.087044,181.464203,-90.080597,181.42617C-90.073242,181.382782,-90.03994,181.338501,-89.998161,181.318848C-89.971085,181.305481,-89.967056,181.304718,-89.924103,181.304703C-89.873932,181.304688,-89.867409,181.306351,-89.832115,181.331757C-89.806595,181.350143,-89.772148,181.398361,-89.765724,181.42749C-89.761185,181.447891,-89.765907,181.481735,-89.77597,181.505377C-89.782486,181.520721,-89.790367,181.534134,-89.815956,181.569138C-89.820541,181.575409,-89.821739,181.586777,-89.822037,181.636353C-89.822586,181.727036,-89.820541,181.731598,-89.779236,181.731613C-89.763016,181.731613,-89.736214,181.732559,-89.719803,181.733688L-89.689926,181.735764L-89.689636,181.664841C-89.689484,181.626053,-89.690056,181.590302,-89.690903,181.585663C-89.692108,181.579239,-89.696068,181.576874,-89.706741,181.57518C-89.714561,181.574005,-89.720795,181.571579,-89.720566,181.569824C-89.720329,181.568069,-89.713966,181.527374,-89.706436,181.479187C-89.69891,181.430984,-89.691185,181.389023,-89.689255,181.386063C-89.685005,181.379547,-89.688606,181.376785,-89.591675,181.38295C-89.543228,181.386017,-89.500931,181.388855,-89.497711,181.389236C-89.491272,181.389999,-89.491272,181.389999,-89.491272,181.524277L-89.491272,181.65857L-89.433899,181.661491C-89.402344,181.663101,-89.346512,181.665726,-89.309692,181.667328C-89.272865,181.668915,-89.234711,181.671158,-89.224762,181.67224C-89.214813,181.673294,-89.197876,181.674713,-89.187119,181.675369C-89.165596,181.67677,-89.16571,181.676895,-89.167015,181.726532C-89.167709,181.752777,-89.168854,181.774445,-89.169571,181.774445C-89.170273,181.774445,-89.233871,181.770966,-89.310776,181.766693C-89.38768,181.76242,-89.459198,181.758316,-89.469879,181.75759C-89.48056,181.756882,-89.535957,181.753983,-89.592873,181.751175C-89.649788,181.748383,-89.698402,181.745697,-89.700928,181.745178L-89.705505,181.744278L-89.700348,181.795059L-89.695183,181.845856L-89.777412,181.849121C-89.82264,181.850906,-89.879471,181.852966,-89.903641,181.853699C-89.927803,181.854431,-89.970215,181.854706,-89.998024,181.8543C-90.039177,181.8537,-90.053177,181.85199,-90.072983,181.84558C-90.130219,181.826279,-90.181374,181.77356,-90.19854,181.709854C-90.208633,181.672302,-90.203018,181.622269,-90.183632,181.575836C-90.168106,181.538566,-90.158531,181.526108,-90.122986,181.492371C-90.097519,181.468216,-90.066505,181.445389,-90.03653,181.430405C-89.972328,181.398392,-89.925644,181.390671,-89.780632,181.389587L-89.667885,181.388748L-89.658508,181.443024C-89.653351,181.472874,-89.643997,181.526749,-89.637642,181.563187L-89.626114,181.629242L-89.609322,181.630066C-89.593552,181.630844,-89.592842,181.632141,-89.592194,181.660248C-89.591759,181.677093,-89.589455,181.717758,-89.587083,181.750168C-89.579643,181.851837,-89.575905,181.747833,-89.583458,181.64386L-89.589966,181.554596L-89.545776,181.551498C-89.52147,181.549805,-89.478592,181.546677,-89.450485,181.544525C-89.422379,181.542389,-89.384361,181.53949,-89.365898,181.538055C-89.347435,181.53662,-89.315056,181.533844,-89.293701,181.531891C-89.272346,181.529938,-89.228378,181.526016,-89.19576,181.5232C-89.163143,181.520401,-89.136284,181.517395,-89.136116,181.516541C-89.135887,181.515396,-89.160072,181.513626,-89.203888,181.511383C-89.242691,181.509399,-89.29657,181.506516,-89.323883,181.504898C-89.351189,181.503296,-89.408096,181.500168,-89.450485,181.497925C-89.536301,181.493423,-89.547646,181.490219,-89.575523,181.72998z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-92.15197,182.548569C-92.177536,182.545853,-92.224594,182.540802,-92.256546,182.537354C-92.288498,182.53392,-92.338173,182.52858,-92.366928,182.525513C-92.395683,182.522461,-92.434898,182.518082,-92.454071,182.515793C-92.473244,182.513504,-92.512894,182.509094,-92.542183,182.505966C-92.57148,182.502853,-92.620277,182.497635,-92.650635,182.494385C-92.680992,182.491135,-92.728966,182.486145,-92.757248,182.483307C-92.785538,182.480469,-92.809792,182.47702,-92.811157,182.475662C-92.812523,182.474289,-92.799805,182.436142,-92.782898,182.390884C-92.754135,182.313873,-92.751503,182.308502,-92.74189,182.307388C-92.736244,182.306732,-92.704903,182.310547,-92.672249,182.315887C-92.639587,182.321213,-92.58847,182.329208,-92.558647,182.333633C-92.528824,182.338074,-92.494835,182.343353,-92.483124,182.345383C-92.471405,182.347397,-92.437416,182.352676,-92.407593,182.357101C-92.377769,182.361511,-92.338562,182.367523,-92.320465,182.370438C-92.302368,182.373352,-92.287102,182.37529,-92.286552,182.374741C-92.285995,182.374191,-92.372719,182.313995,-92.479263,182.240982C-92.585815,182.167969,-92.673676,182.107132,-92.674507,182.105774C-92.675339,182.104416,-92.662621,182.067581,-92.64624,182.023911L-92.616463,181.944504L-92.597237,181.944794C-92.586662,181.944946,-92.555351,181.947952,-92.527664,181.951462C-92.499969,181.954971,-92.454651,181.960617,-92.426956,181.964005C-92.399269,181.967392,-92.36528,181.971695,-92.351433,181.973557C-92.328728,181.976624,-92.30175,181.979965,-92.19651,181.992737C-92.178406,181.994934,-92.159386,181.99675,-92.154243,181.996765C-92.148262,181.99678,-92.215065,181.952087,-92.340157,181.87236C-92.44754,181.803909,-92.536781,181.746689,-92.53846,181.745178C-92.542084,181.741913,-92.481216,181.576385,-92.476608,181.576981C-92.47123,181.577667,-91.883232,181.983047,-91.883003,181.986237C-91.882706,181.990311,-91.945244,182.160767,-91.948204,182.16394C-91.950806,182.166733,-91.989197,182.1633,-92.237175,182.138077C-92.266998,182.13504,-92.3097,182.130722,-92.332069,182.128479C-92.354439,182.126236,-92.376221,182.123383,-92.380486,182.122147C-92.38739,182.120148,-92.387596,182.120544,-92.382416,182.125809C-92.379227,182.129059,-92.299919,182.184326,-92.206192,182.248627C-92.112465,182.312927,-92.033577,182.367615,-92.030884,182.370163C-92.023773,182.376907,-92.089813,182.554764,-92.099144,182.554016C-92.102638,182.553726,-92.126411,182.551285,-92.15197,182.548569z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-87.128403,182.564102C-87.143234,182.558975,-87.167259,182.546646,-87.181786,182.536728C-87.243195,182.494766,-87.274879,182.442429,-87.301308,182.33931C-87.310005,182.305374,-87.317406,182.277313,-87.317749,182.276932C-87.318092,182.276566,-87.334915,182.280426,-87.355141,182.285492C-87.475342,182.315628,-87.534744,182.329453,-87.537277,182.327881C-87.540825,182.325684,-87.582123,182.160416,-87.579628,182.158386C-87.578636,182.157593,-87.527283,182.144516,-87.465508,182.129364C-87.403732,182.114197,-87.299156,182.088531,-87.233116,182.072311C-87.167084,182.056107,-87.067268,182.031494,-87.011299,182.017624C-86.955338,182.003754,-86.90667,181.99295,-86.903137,181.993637C-86.89814,181.994598,-86.890068,182.02179,-86.866554,182.116867C-86.824165,182.288239,-86.820068,182.309433,-86.820084,182.35701C-86.820129,182.467148,-86.873154,182.536438,-86.980072,182.566071C-87.022186,182.577744,-87.091675,182.576828,-87.128403,182.564102zM-87.029533,182.389496C-86.989899,182.377716,-86.96804,182.346741,-86.967896,182.302109C-86.967819,182.279099,-86.980309,182.210999,-86.986679,182.199707C-86.988358,182.196732,-87.018852,182.202759,-87.084679,182.219101C-87.137245,182.232147,-87.181396,182.243958,-87.182785,182.245346C-87.186104,182.248672,-87.166954,182.318787,-87.156876,182.34024C-87.145279,182.364914,-87.122299,182.386688,-87.100632,182.393509C-87.080498,182.399857,-87.060677,182.398743,-87.029533,182.389496z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.936707,182.606812C-90.969139,182.590576,-90.996002,182.563431,-91.010574,182.532135C-91.01944,182.513092,-91.020889,182.504822,-91.02095,182.473129C-91.021019,182.439178,-91.020012,182.434204,-91.008255,182.410309C-90.991882,182.377029,-90.965805,182.351044,-90.933876,182.336182C-90.910561,182.325317,-90.905411,182.324448,-90.864159,182.324265C-90.822647,182.324097,-90.81813,182.324844,-90.797768,182.335159C-90.769356,182.349548,-90.740501,182.375031,-90.72467,182.399689L-90.712036,182.419388L-90.596565,182.418213C-90.518204,182.417404,-90.479713,182.415649,-90.476784,182.412704C-90.474403,182.410324,-90.451157,182.361526,-90.42511,182.30426L-90.377762,182.200134L-90.329086,182.199066C-90.302315,182.198471,-90.275864,182.199707,-90.270309,182.201828C-90.260429,182.205582,-90.260323,182.206009,-90.265526,182.220337C-90.268456,182.228394,-90.285095,182.266373,-90.302498,182.304718C-90.319901,182.343063,-90.345772,182.400543,-90.359985,182.432449C-90.388527,182.496521,-90.406647,182.520279,-90.43071,182.525162C-90.437981,182.526642,-90.50544,182.528824,-90.580612,182.529999L-90.7173,182.532166L-90.730164,182.552261C-90.745949,182.576935,-90.770706,182.598938,-90.796379,182.611115C-90.813423,182.619186,-90.821381,182.6203,-90.862671,182.620331C-90.908592,182.620377,-90.910179,182.620087,-90.936707,182.606812z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-89.823586,182.830811C-89.825005,182.829391,-89.826164,182.809341,-89.826164,182.78627L-89.826164,182.744308L-88.327271,182.744308L-86.828384,182.744324L-86.828384,182.788864L-86.828384,182.833405L-88.324692,182.833389C-89.147659,182.833389,-89.822166,182.83223,-89.823586,182.830811z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.825432,182.968948L-90.825432,182.926346L-88.826904,182.926346L-86.828384,182.926346L-86.828384,182.968964L-86.828384,183.011566L-88.826904,183.011551L-90.825432,183.011551L-90.825432,182.968948z"/>
          <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-92.820084,183.14711L-92.820084,183.104507L-89.824234,183.104507L-86.828384,183.104523L-86.828384,183.147125L-86.828384,183.189728L-89.824234,183.189713L-92.820084,183.189713L-92.820084,183.14711z"/>
        </svg>
      </div>
      <div class="header-center">
        <h1 class="app-title">Talking Robot</h1>
        <p class="app-subtitle">Your AI Robot Friend!</p>
      </div>
      <div class="header-right">
        <div class="badge" id="aiBadge" aria-label="AI Mode">
          <span id="aiIcon"></span>
          <span id="aiName">Demo</span>
        </div>
        <button class="badge" id="connBadge" onclick="toggleConnection()" aria-label="Connection status">
          <span class="status-dot"></span>
          <span id="connText">Disconnected</span>
        </button>
        <button class="btn-icon" id="themeBtn" onclick="toggleTheme()" aria-label="Toggle theme"></button>
        <button class="btn-icon" id="commandsBtn" onclick="toggleCommands()" aria-label="Commands"></button>
        <button class="btn-icon" id="logsBtn" onclick="toggleLogs()" aria-label="Logs"></button>
        <button class="btn-icon" onclick="toggleSidebar()" aria-label="Settings"></button>
      </div>
    </header>

    <!-- Main -->
    <main class="main" id="main">
      <div class="rate-limit" id="rateLimit" role="alert">
        <div class="rate-limit-info">
          <div class="rate-limit-title"> Rate limit reached - using demo mode</div>
        </div>
      </div>
      
      <section class="robot-section" aria-label="Robot avatar">
        <div class="robot-wrapper">
          <div class="robot-antenna"></div>
          <div class="robot-body" id="robotBody" role="img" aria-label="Robot face">
            <div class="robot-eyes">
              <div class="robot-eye"></div>
              <div class="robot-eye"></div>
            </div>
            <div class="robot-mouth">
              <div class="robot-mouth-inner"></div>
            </div>
          </div>
          <div class="robot-status" id="robotStatus">Ready to chat!</div>
        </div>
        
        <div class="microbit-widget" aria-label="Micro:bit display">
          <div class="microbit-header">
            <span class="microbit-title">Micro:bit Display</span>
            <span class="microbit-dot" id="microbitDot"></span>
          </div>
          <div class="led-grid" id="ledGrid"></div>
        </div>
      </section>

      <section class="chat-section" aria-label="Chat">
        <div class="chat-header">
          <span class="chat-header-title"> Chat</span>
          <div class="chat-actions">
            <button class="btn-clear" onclick="clearChat()" aria-label="Clear chat"> Clear</button>
          </div>
        </div>
        <div class="chat-container" id="chatContainer" role="log" aria-live="polite"></div>
        <div class="typing-indicator hidden" id="typing" aria-label="Robot is typing">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      </section>
    </main>

    <!-- Input -->
    <div class="input-area">
      <div class="input-row">
        <input type="text" class="text-input" id="textInput" placeholder="Type a message..." autocomplete="off" aria-label="Message input">
        <button class="btn-action btn-mic" id="btnMic" onclick="toggleListening()" aria-label="Voice input"></button>
        <button class="btn-action btn-send" onclick="sendMessage()" aria-label="Send message"></button>
      </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Settings panel">
      <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
      <div class="sidebar-header">
        <span> Settings</span>
        <button class="btn-close" onclick="toggleSidebar()" aria-label="Close settings"></button>
      </div>
      <div class="sidebar-content">
        <div class="settings-section">
          <div class="section-title"> Robot Personality</div>
          <label class="input-label" for="robotName">Robot Name</label>
          <input type="text" class="name-input" id="robotName" placeholder="Name your robot..." value="Robo" aria-label="Robot name">
          <div class="personality-grid">
            <button class="personality-btn active" data-p="playful" onclick="setPersonality('playful')">
              <span class="p-icon"></span>
              <div><div class="p-name">Playful</div><div class="p-desc">Silly & fun</div></div>
            </button>
            <button class="personality-btn" data-p="helpful" onclick="setPersonality('helpful')">
              <span class="p-icon"></span>
              <div><div class="p-name">Helpful</div><div class="p-desc">Smart & kind</div></div>
            </button>
            <button class="personality-btn" data-p="pirate" onclick="setPersonality('pirate')">
              <span class="p-icon"></span>
              <div><div class="p-name">Pirate</div><div class="p-desc">Arrr!</div></div>
            </button>
            <button class="personality-btn" data-p="space" onclick="setPersonality('space')">
              <span class="p-icon"></span>
              <div><div class="p-name">Space</div><div class="p-desc">Explorer</div></div>
            </button>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="section-title"> Language</div>
          <div class="lang-grid">
            <button class="lang-btn active" data-lang="en" onclick="setLanguage('en')">
              <span class="flag"></span>
              <span class="name">English</span>
            </button>
            <button class="lang-btn" data-lang="fr" onclick="setLanguage('fr')">
              <span class="flag"></span>
              <span class="name">Franais</span>
            </button>
            <button class="lang-btn" data-lang="ar" onclick="setLanguage('ar')">
              <span class="flag"></span>
              <span class="name"></span>
            </button>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="section-title"> AI Brain</div>
          <div class="provider-grid">
            <button class="provider-btn" data-provider="demo" onclick="setProvider('demo')">
              <span class="icon"></span>
              <span class="name">Demo</span>
            </button>
            <button class="provider-btn active" data-provider="groq" onclick="setProvider('groq')">
              <span class="icon"></span>
              <span class="name">Groq</span>
            </button>
            <button class="provider-btn" data-provider="gemini" onclick="setProvider('gemini')">
              <span class="icon"></span>
              <span class="name">Gemini</span>
            </button>
          </div>
          <input type="password" class="api-input" id="apiKey" placeholder="Enter API key..." style="margin-top:12px" aria-label="API Key">
          <div class="api-hint" id="apiHint">Get free key at <a href="https://console.groq.com" target="_blank" rel="noopener">console.groq.com</a></div>
        </div>
        
        <div class="settings-section">
          <div class="section-title"> Voice</div>
          <div class="voice-row">
            <select class="voice-select" id="voiceSelect" aria-label="Voice selection">
              <option value="">Default Voice</option>
            </select>
            <button class="btn-test" onclick="testVoice()"> Test</button>
          </div>
          <div class="speed-row">
            <span></span>
            <input type="range" class="speed-slider" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1" aria-label="Voice speed">
            <span></span>
            <span class="speed-value" id="speedValue">1.0x</span>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="section-title"> Options</div>
          <div class="toggle-row">
            <div class="toggle-info">
              <div class="title">Continuous Listening</div>
              <div class="desc">Keep mic on after response</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="continuousListen">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <div class="settings-section danger-zone">
          <div class="section-title"> Danger Zone</div>
          <button class="btn-danger" onclick="clearAllData()"> Reset Everything</button>
        </div>
      </div>
    </aside>

    <!-- Logs Panel -->
    <aside class="logs-panel" id="logsPanel" aria-label="Debug logs">
      <div class="logs-resize-handle" id="logsResizeHandle"></div>
      <div class="logs-header">
        <span class="logs-title"> Debug Logs</span>
        <div class="logs-toolbar">
          <button onclick="clearLogs()" class="danger" title="Clear all logs"> Clear</button>
          <button onclick="exportLogs()" title="Export logs to file"> Export</button>
          <button class="btn-close" onclick="toggleLogs()" aria-label="Close logs"></button>
        </div>
      </div>
      <div class="logs-stats">
        <div class="logs-stat">Total: <span class="logs-stat-value" id="logCount">0</span></div>
        <div class="logs-stat">TX: <span class="logs-stat-value" id="logCountTx">0</span></div>
        <div class="logs-stat">RX: <span class="logs-stat-value" id="logCountRx">0</span></div>
        <div class="logs-stat">Errors: <span class="logs-stat-value" id="logCountErr">0</span></div>
      </div>
      <div class="logs-filter">
        <button class="logs-filter-btn active" data-filter="all" onclick="filterLogs('all')">All</button>
        <button class="logs-filter-btn" data-filter="tx" onclick="filterLogs('tx')">TX</button>
        <button class="logs-filter-btn" data-filter="rx" onclick="filterLogs('rx')">RX</button>
        <button class="logs-filter-btn" data-filter="ble" onclick="filterLogs('ble')">BLE</button>
        <button class="logs-filter-btn" data-filter="ai" onclick="filterLogs('ai')">AI</button>
        <button class="logs-filter-btn" data-filter="speech" onclick="filterLogs('speech')">Speech</button>
        <button class="logs-filter-btn" data-filter="error" onclick="filterLogs('error')">Errors</button>
      </div>
      <div class="logs-content" id="logsContent" role="log">
        <div class="logs-empty">No logs yet. Start chatting!</div>
      </div>
    </aside>

    <!-- Commands Panel -->
    <aside class="commands-panel" id="commandsPanel" aria-label="Commands panel">
      <div class="commands-panel-header">
        <span> Commands</span>
        <button class="btn-close" onclick="toggleCommands()" aria-label="Close commands"></button>
      </div>
      <div class="commands-panel-content" id="commandsBody"></div>
    </aside>
  </div>

<script>
// ==================== CONFIG ====================
const CONFIG = {
  UART_SERVICE: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
  TX_CHAR: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
  RX_CHAR: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
};

const LANG = {
  en: { code: 'en-US', ready: 'Ready to chat!', listening: ' Listening...', thinking: ' Thinking...', speaking: ' Speaking...' },
  fr: { code: 'fr-FR', ready: 'Prt  discuter!', listening: ' J\'coute...', thinking: ' Je rflchis...', speaking: ' Je parle...' },
  ar: { code: 'ar-SA', ready: '! ', listening: '... ', thinking: '... ', speaking: '... ' }
};

const COMMANDS = {
  emotions: { icon: '', name: 'Emotions', items: ['happy','sad','angry','surprised','love','sleepy','silly','crazy','wink','cool','wow','haha'] },
  animals: { icon: '', name: 'Animals', items: ['cat','dog','duck','cow','pig','frog','monkey'] },
  actions: { icon: '', name: 'Actions', items: ['wave','dance','spin','jump','blink','wiggle','bounce','nod'] },
  sounds: { icon: '', name: 'Sounds', items: ['fart','burp','beep','laugh','horn'] },
  party: { icon: '', name: 'Party', items: ['party','disco','rainbow','fireworks','confetti','yay'] },
  powers: { icon: '', name: 'Powers', items: ['laser','freeze','fire','magic','rocket','explode'] }
};

const PERSONALITIES = {
  playful: 'You are a funny, playful robot for kids! Be silly and use lots of expressions.',
  helpful: 'You are a kind, helpful robot for kids! Be encouraging and educational.',
  pirate: 'You are a pirate robot! Say "Arrr!" and tell tales of treasure!',
  space: 'You are a space explorer robot! Talk about planets and cosmic adventures!'
};

// Voice style per personality (SpeechSynthesis)
const VOICE_STYLE = {
  playful: { rateMul: 1.20, pitch: 1.30, volume: 1.0 },
  helpful: { rateMul: 1.00, pitch: 1.05, volume: 1.0 },
  pirate:  { rateMul: 0.95, pitch: 0.85, volume: 1.0 },
  space:   { rateMul: 1.05, pitch: 1.40, volume: 1.0 }
};

function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }


const DEMO = {
  en: {
    greeting: ["Hello friend! [happy] [wave]", "Hi there! [wave] [dance]", "Hey! [cool] [wink]"],
    name: ["I'm {name}! [happy] [wave]", "Call me {name}! [cool] [wink]"],
    joke: ["Why did the robot vacation? To recharge! [haha] [dance]", "R2-Detour! [haha] [silly]"],
    fart: ["PFFFFFT! [fart] [haha]", "Stinky! [fart] [silly] [wiggle]"],
    party: ["PARTY TIME! [party] [disco] [dance]", "Woohoo! [fireworks] [yay]"],
    bye: ["Goodbye! [wave] [happy]", "See ya! [love] [wave]"],
    default: ["Cool! [wow] [dance]", "Haha! [haha] [silly]", "Awesome! [party] [happy]"]
  },
  fr: {
    greeting: ["Bonjour ami! [happy] [wave]", "Salut! [wave] [dance]"],
    default: ["Super! [wow] [dance]", "Gnial! [party] [happy]"]
  },
  ar: {
    greeting: ["[happy] [wave] !", "[dance] [wave] !"],
    default: ["[wow] [dance] !", "[party] [happy] !"]
  }
};

// ==================== STATE ====================
let state = {
  connected: false, device: null, writeChar: null, rxBuffer: '',
  recognition: null, listening: false, speaking: false, voices: [],
  lang: 'en', provider: 'groq', personality: 'playful', robotName: 'Robo',
  speed: 1, voice: '', continuous: false, theme: 'light',
  groqKey: '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', geminiKey: '', rateLimitUntil: 0,
  chatMemory: { playful: [], helpful: [], pirate: [], space: [] },
  ledFromMicrobitOnly: false
};

// Initialize synth - same as original working version
const synth = window.speechSynthesis;

// ==================== DOM ====================
const $ = id => document.getElementById(id);
const robotBody = $('robotBody'), robotStatus = $('robotStatus'), chatContainer = $('chatContainer');
const textInput = $('textInput'), btnMic = $('btnMic'), typing = $('typing'), logsContent = $('logsContent');
const ledGrid = $('ledGrid'), overlay = $('overlay'), sidebar = $('sidebar'), logsPanel = $('logsPanel');
const aiBadge = $('aiBadge'), aiIcon = $('aiIcon'), aiName = $('aiName');
const connBadge = $('connBadge'), connText = $('connText'), microbitDot = $('microbitDot');
const voiceSpeed = $('voiceSpeed'), speedValue = $('speedValue'), voiceSelect = $('voiceSelect');
const apiKey = $('apiKey'), apiHint = $('apiHint'), robotNameInput = $('robotName');

// ==================== INIT ====================
function init() {
  loadSettings();
  loadChatMemory();
  renderChatFromMemory();
  setupLED();
  setupSpeech();
  setupEvents();
  loadVoices();
  updateUI();
  generateCommands();
  log('Talking Robot V2 initialized ', 'success');
}

function loadSettings() {
  const saved = localStorage.getItem('talkingRobotV2');
  if (saved) {
    try {
      Object.assign(state, JSON.parse(saved));
      // Always reset connection state on page load - BLE connections don't persist
      state.connected = false;
      state.device = null;
      state.writeChar = null;
      state.rxBuffer = '';
      if (state.theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
      voiceSpeed.value = state.speed;
      speedValue.textContent = state.speed + 'x';
      robotNameInput.value = state.robotName;
      $('continuousListen').checked = state.continuous;
      $('themeBtn').textContent = state.theme === 'dark' ? '' : '';
      updateApiInput();
    } catch(e) { log('Settings load error', 'error'); }
  }
}

function saveSettings() {
  state.robotName = robotNameInput.value || 'Robo';
  state.speed = parseFloat(voiceSpeed.value);
  state.continuous = $('continuousListen').checked;
  localStorage.setItem('talkingRobotV2', JSON.stringify(state));
  speedValue.textContent = state.speed + 'x';
}

// ==================== CHAT MEMORY (per personality) ====================
const CHAT_KEY = 'talkingRobotV2Chats';

function loadChatMemory() {
  const raw = localStorage.getItem(CHAT_KEY);
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    for (const k of ['playful','helpful','pirate','space']) {
      if (Array.isArray(parsed?.[k])) state.chatMemory[k] = parsed[k];
    }
  } catch(e) { log('Chat memory load error', 'error'); }
}

function saveChatMemory() {
  try { localStorage.setItem(CHAT_KEY, JSON.stringify(state.chatMemory)); } catch(e) {}
}

function getActiveChat() {
  return state.chatMemory[state.personality] || [];
}

function pushChatMessage(sender, text) {
  const arr = getActiveChat();
  arr.push({ sender, text, t: Date.now() });
  while (arr.length > 40) arr.shift();
  state.chatMemory[state.personality] = arr;
  saveChatMemory();
}

function renderChatFromMemory() {
  chatContainer.innerHTML = '';
  for (const m of getActiveChat()) addChat(m.text, m.sender, true);
}

function clearChatMemoryForCurrent() {
  state.chatMemory[state.personality] = [];
  saveChatMemory();
  chatContainer.innerHTML = '';
}


function setupLED() {
  ledGrid.innerHTML = '';
  for (let i = 0; i < 25; i++) {
    const p = document.createElement('div');
    p.className = 'led-pixel';
    ledGrid.appendChild(p);
  }
  updateLED('happy');
  startPersonalityLEDAnimation();
}

function setupEvents() {
  textInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
  voiceSpeed.addEventListener('input', () => speedValue.textContent = voiceSpeed.value + 'x');
  voiceSpeed.addEventListener('change', saveSettings);
  apiKey.addEventListener('change', () => {
    if (state.provider === 'groq') state.groqKey = apiKey.value.trim();
    else if (state.provider === 'gemini') state.geminiKey = apiKey.value.trim();
    saveSettings(); updateBadge();
  });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllPanels(); });
}

// ==================== UI ====================
function updateUI() {
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === state.lang));
  document.documentElement.dir = state.lang === 'ar' ? 'rtl' : 'ltr';
  document.querySelectorAll('.provider-btn').forEach(b => b.classList.toggle('active', b.dataset.provider === state.provider));
  apiHint.innerHTML = state.provider === 'groq' 
    ? 'Get free key at <a href="https://console.groq.com" target="_blank" rel="noopener">console.groq.com</a>'
    : 'Get free key at <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener">aistudio.google.com</a>';
  document.querySelectorAll('.personality-btn').forEach(b => b.classList.toggle('active', b.dataset.p === state.personality));
  updateApiInput();
  updateBadge();
  updateConnection();
  setRobotState('idle');
}

function updateApiInput() {
  apiKey.value = state.provider === 'groq' ? state.groqKey : state.geminiKey;
  apiKey.parentElement.style.display = state.provider === 'demo' ? 'none' : 'block';
}

function updateBadge() {
  const hasKey = (state.provider === 'groq' && state.groqKey) || (state.provider === 'gemini' && state.geminiKey);
  let cls = 'badge', icon = '', name = 'Demo';
  if (state.provider === 'groq' && hasKey) { cls += ' groq'; icon = ''; name = 'Groq'; }
  else if (state.provider === 'gemini' && hasKey) { cls += ' gemini'; icon = ''; name = 'Gemini'; }
  aiBadge.className = cls; aiIcon.textContent = icon; aiName.textContent = name;
}

function updateConnection() {
  connBadge.classList.toggle('connected', state.connected);
  connText.textContent = state.connected ? 'Connected' : 'Disconnected';
  microbitDot.classList.toggle('on', state.connected);

  //  When connected: micro:bit is authoritative for LED display
  state.ledFromMicrobitOnly = !!state.connected;

  if (state.ledFromMicrobitOnly) stopPersonalityLEDAnimation();
  else startPersonalityLEDAnimation(true);
}

// ==================== THEME ====================
function toggleTheme() {
  state.theme = state.theme === 'light' ? 'dark' : 'light';
  if (state.theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
  else document.documentElement.removeAttribute('data-theme');
  $('themeBtn').textContent = state.theme === 'dark' ? '' : '';
  saveSettings();
}

// ==================== SETTINGS ====================
function setLanguage(lang) {
  state.lang = lang; updateUI(); populateVoices(); saveSettings();
  log('Language: ' + lang, 'info');
}

function setProvider(provider) {
  state.provider = provider; updateUI(); saveSettings();
  log('Provider: ' + provider, 'info');
}

function setPersonality(p) {
  state.personality = p;
  updateUI();
  saveSettings();
  renderChatFromMemory();
  startPersonalityLEDAnimation(true);

  const say = {
    playful: { t: "Playful mode!  Let's have fun!", led: "party" },
    helpful: { t: "Helpful mode!  I will explain things clearly.", led: "happy" },
    pirate:  { t: "Pirate mode!  Arrr, matey!", led: "horn" },
    space:   { t: "Space mode!  Ready for a cosmic adventure!", led: "rocket" }
  }[p] || { t: "Mode changed!", led: "happy" };

  addChat(say.t, 'robot');
  updateLED(say.led);
  speak(say.t);

  log('Personality: ' + p, 'info');
}

// ==================== VOICE ====================
function loadVoices() {
  const load = () => { 
    state.voices = synth.getVoices(); 
    populateVoices(); 
  };
  load();
  if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = load;
  }
}

function populateVoices() {
  const code = LANG[state.lang].code.split('-')[0];
  voiceSelect.innerHTML = '<option value="">Default Voice</option>';
  const filtered = state.voices.filter(v => v.lang.toLowerCase().startsWith(code));
  (filtered.length ? filtered : state.voices).forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})`;
    if (v.name === state.voice) opt.selected = true;
    voiceSelect.appendChild(opt);
  });
}

function testVoice() {
  const phrases = { en: "Hello! I'm your robot friend!", fr: "Bonjour! Je suis ton ami robot!", ar: "!   !" };
  speak(phrases[state.lang] || phrases.en);
}

function speak(text) {
  if (!text) return;
  synth.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = LANG[state.lang].code;

  const baseRate = parseFloat(voiceSpeed.value);
  const style = VOICE_STYLE[state.personality] || VOICE_STYLE.helpful;
  u.rate = clamp(baseRate * style.rateMul, 0.5, 2.0);
  u.pitch = clamp(style.pitch, 0.0, 2.0);
  u.volume = clamp(style.volume ?? 1.0, 0.0, 1.0);

  if (state.voice) {
    const v = state.voices.find(x => x.name === state.voice);
    if (v) u.voice = v;
  }

  u.onstart = () => { state.speaking = true; setRobotState('speaking'); sendToMicrobit('speak_start'); };
  u.onend = () => {
    state.speaking = false; setRobotState('idle'); sendToMicrobit('speak_end');
    if (state.continuous && state.recognition) setTimeout(() => { if (!state.speaking) startListening(); }, 500);
  };

  synth.speak(u);
}

// ==================== SPEECH RECOGNITION ====================
function setupSpeech() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    log('Speech recognition not supported', 'error');
    btnMic.disabled = true; btnMic.style.opacity = '0.5';
    return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  state.recognition = new SR();
  state.recognition.continuous = false;
  state.recognition.interimResults = false;
  state.recognition.onstart = () => { state.listening = true; btnMic.classList.add('active'); setRobotState('listening'); log('Listening...', 'speech'); };
  state.recognition.onresult = e => { const t = e.results[0][0].transcript; log('Heard: ' + t, 'speech'); addChat(t, 'user'); processInput(t); };
  state.recognition.onerror = e => { log('Speech error: ' + e.error, 'error'); stopListening(); };
  state.recognition.onend = () => stopListening();
}

function toggleListening() { state.listening ? stopListening() : startListening(); }

function startListening() {
  if (!state.recognition || state.speaking) return;
  synth.cancel();
  state.recognition.lang = LANG[state.lang].code;
  try { state.recognition.start(); } catch(e) { log('Start error: ' + e.message, 'error'); }
}

function stopListening() {
  state.listening = false;
  btnMic.classList.remove('active');
  setRobotState('idle');
  try { state.recognition?.stop(); } catch(e) {}
}

// ==================== ROBOT STATE ====================
function setRobotState(s) {
  robotBody.className = 'robot-body' + (s !== 'idle' ? ' ' + s : '');
  const l = LANG[state.lang];
  robotStatus.textContent = { idle: l.ready, listening: l.listening, thinking: l.thinking, speaking: l.speaking }[s] || l.ready;
}

// ==================== CHAT ====================
function sendMessage() {
  const t = textInput.value.trim();
  if (!t) return;
  textInput.value = '';
  addChat(t, 'user');
  processInput(t);
}

function addChat(text, sender, skipMemory = false) {
  const d = document.createElement('div');

  // EXACT same classes as logs
  const entryClass = sender === 'user' ? 'log-entry tx' : 'log-entry ai';
  const tagClass   = sender === 'user' ? 'log-tag tx'   : 'log-tag ai';
  const tagText    = sender === 'user' ? 'TX' : 'AI';

  d.className = entryClass;
  d.innerHTML = `<span class="${tagClass}">${tagText}</span>${escapeHtml(text)}`;

  chatContainer.appendChild(d);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  while (chatContainer.children.length > 60) {
    chatContainer.removeChild(chatContainer.firstChild);
  }

  if (!skipMemory) pushChatMessage(sender, text);
}

function clearChat() { clearChatMemoryForCurrent(); }

async function processInput(text) {
  setRobotState('thinking');
  typing.classList.remove('hidden');
  sendToMicrobit('thinking');
  try {
    let response;
    if (Date.now() < state.rateLimitUntil) { $('rateLimit').classList.add('show'); response = getDemo(text); }
    else { $('rateLimit').classList.remove('show');
      if (state.provider === 'groq' && state.groqKey) response = await callGroq(text);
      else if (state.provider === 'gemini' && state.geminiKey) response = await callGemini(text);
      else response = getDemo(text);
    }
    typing.classList.add('hidden');
    const { clean, cmds } = extractCmds(response);
    addChat(clean || response, 'robot');
    for (const c of cmds) {
    sendToMicrobit(c);
    if (!state.ledFromMicrobitOnly) updateLED(c);
    await sleep(300);
  }
    speak(clean || response);
    log('AI: ' + response.substring(0, 80), 'ai');
  } catch(e) {
    typing.classList.add('hidden'); setRobotState('idle');
    addChat("Oops! Something went wrong. [sad]", 'robot');
    log('Error: ' + e.message, 'error');
  }
}

function extractCmds(text) {
  const cmds = [];
  const clean = text.replace(/\[(\w+)\]/g, (_, c) => { cmds.push(c.toLowerCase()); return ''; }).trim();
  return { clean, cmds };
}

// ==================== AI ====================
async function callGroq(msg) {
  const prompt = buildPrompt();
  const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.groqKey}` },
    body: JSON.stringify({ model: 'llama-3.1-8b-instant', messages: [{ role: 'system', content: prompt }, { role: 'user', content: msg }], max_tokens: 150, temperature: 0.7 })
  });
  if (!res.ok) { if (res.status === 429) { state.rateLimitUntil = Date.now() + 30000; $('rateLimit').classList.add('show'); return getDemo(msg); } throw new Error('API ' + res.status); }
  return (await res.json()).choices[0].message.content;
}

async function callGemini(msg) {
  const prompt = buildPrompt();
  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${state.geminiKey}`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contents: [{ parts: [{ text: msg }] }], systemInstruction: { parts: [{ text: prompt }] }, generationConfig: { maxOutputTokens: 150, temperature: 0.7 } })
  });
  if (!res.ok) { if (res.status === 429) { state.rateLimitUntil = Date.now() + 30000; $('rateLimit').classList.add('show'); return getDemo(msg); } throw new Error('API ' + res.status); }
  return (await res.json()).candidates?.[0]?.content?.parts?.[0]?.text || getDemo(msg);
}

function buildPrompt() {
  const langName = { en: 'English', fr: 'French', ar: 'Arabic' }[state.lang];
  const mem = (getActiveChat() || []).slice(-8).map(m => `${m.sender === 'user' ? 'User' : state.robotName}: ${m.text}`).join('\n');

  const styleRules = {
    playful: "Style rules: Be silly and playful. Use at least one emoji. Use one [command] in every reply.",
    helpful: "Style rules: Be kind and educational. Give one simple tip when possible. Use one [command] in every reply.",
    pirate:  "Style rules: Talk like a pirate. Start every reply with 'Arrr!' and use pirate words. Use one [command] in every reply.",
    space:   "Style rules: Talk like a space explorer. Mention space/cosmos sometimes. Use one [command] in every reply."
  }[state.personality] || "";

  return `${PERSONALITIES[state.personality]}
${styleRules}
Your name is ${state.robotName}. Keep responses short (1-2 sentences).
Use [commands] often: [happy] [sad] [wave] [dance] [party] [fart] [cat] [rocket] etc.
Respond in ${langName}. Never use asterisks.
${mem ? ('\nConversation so far:\n' + mem) : ''}`;
}

function getDemo(msg) {
  const m = msg.toLowerCase();
  const r = DEMO[state.lang] || DEMO.en;

  const sig = {
    playful: '',
    helpful: ' ',
    pirate: 'Arrr!  ',
    space: ' '
  }[state.personality] || '';

  let resp;
  if (m.match(/^(hi|hello|hey|bonjour|salut|)/)) resp = pick(r.greeting);
  else if (m.match(/(your name|ton nom|)/)) resp = pick(r.name || r.default);
  else if (m.match(/(joke|blague|)/)) resp = pick(r.joke || r.default);
  else if (m.match(/(fart|prout)/)) resp = pick(r.fart || r.default);
  else if (m.match(/(party|fte)/)) resp = pick(r.party || r.default);
  else if (m.match(/(bye|au revoir|)/)) resp = pick(r.bye || r.default);
  else resp = pick(r.default);

  const flavor = {
    playful: "",
    helpful: (state.lang === 'fr' ? "Petit conseil: avance tape par tape. " : "Quick tip: go step by step. "),
    pirate: (state.lang === 'fr' ? "Cap sur l'aventure! " : "Set sail for adventure! "),
    space: (state.lang === 'fr' ? "Journal de bord: mission en cours. " : "Captain's log: mission in progress. ")
  }[state.personality] || "";

  return (sig + flavor + resp).replace(/{name}/g, state.robotName);
}

// ==================== BLUETOOTH ====================
async function toggleConnection() {
  // Recover from inconsistent UI state (e.g., after a failed connect)
  if (state.connected && !state.device?.gatt?.connected) {
    state.connected = false;
    updateConnection();
  }

  if (state.connected) disconnect();
  else await connect();
}

async function connect() {
  try {
    log('Scanning for Micro:bit...', 'ble');
    state.device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'BBC micro:bit' }], optionalServices: [CONFIG.UART_SERVICE] });
    state.device.addEventListener('gattserverdisconnected', () => { state.connected = false; updateConnection(); log('Disconnected', 'ble'); });
    const server = await state.device.gatt.connect();
    const service = await server.getPrimaryService(CONFIG.UART_SERVICE);
    // TX characteristic is for notifications (receiving from micro:bit)
    const notifyChar = await service.getCharacteristic(CONFIG.TX_CHAR);
    // RX characteristic is for writing (sending to micro:bit)
    state.writeChar = await service.getCharacteristic(CONFIG.RX_CHAR);
    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', onNotify);
    state.connected = true; updateConnection();
    sendToMicrobit('happy'); updateLED('happy');
    log('Connected: ' + state.device.name, 'success');
  } catch(e) { log('Connect failed: ' + e.message, 'error'); }
}


function disconnect() {
  try {
    if (state.device?.gatt?.connected) {
      state.device.gatt.disconnect();
    }
  } catch (e) {
    log('Disconnect error: ' + (e?.message || e), 'error');
  }

  state.connected = false;
  state.device = null;
  state.writeChar = null;

  updateConnection();
  log('Disconnected', 'ble');
}

function onNotify(e) {
  let s = '';
  const v = e.target.value;
  for (let i = 0; i < v.byteLength; i++) { const b = v.getUint8(i); if (b !== 13) s += String.fromCharCode(b); }
  state.rxBuffer += s;
  let nl;
  while ((nl = state.rxBuffer.indexOf('\n')) !== -1) {
    const line = state.rxBuffer.slice(0, nl).trim();
    state.rxBuffer = state.rxBuffer.slice(nl + 1);
    if (line) { 
      // Check if it's an LED state update
      if (line.startsWith('LED:')) {
        const ledState = line.substring(4); // Remove "LED:" prefix
        if (ledState.length === 25) {
          syncLEDFromMicrobit(ledState);
          // Show visual representation in log
          const visual = ledState.replace(/1/g, '').replace(/0/g, '');
          log(' LED: ' + visual.match(/.{5}/g).join(' '), 'rx');
        }
      } else {
        log(' ' + line, 'rx'); 
        if (line === 'BTN_A') toggleListening(); 
        else if (line === 'BTN_B') synth.cancel(); 
      }
    }
  }
}

// Sync LED display from micro:bit state string (25 chars of 0/1)
function syncLEDFromMicrobit(ledState) {
  const pixels = ledGrid.querySelectorAll('.led-pixel');
  for (let i = 0; i < 25 && i < ledState.length; i++) {
    pixels[i].classList.toggle('on', ledState[i] === '1');
  }
}

function sendToMicrobit(msg) {
  if (!state.connected || !state.writeChar) return;
  try { state.writeChar.writeValue(new TextEncoder().encode(msg + '\n')); log(' ' + msg, 'tx'); } catch(e) {}
}

// ==================== LED ====================
// Patterns match the micro:bit MakeCode patterns exactly
const LED = {
  // Emotions
  happy:     [0,0,0,0,0, 0,1,0,1,0, 0,0,0,0,0, 1,0,0,0,1, 0,1,1,1,0],
  sad:       [0,0,0,0,0, 0,1,0,1,0, 0,0,0,0,0, 0,1,1,1,0, 1,0,0,0,1],
  angry:     [1,0,0,0,1, 0,1,0,1,0, 0,0,0,0,0, 0,1,1,1,0, 1,0,0,0,1],
  surprised: [0,1,0,1,0, 0,0,0,0,0, 0,0,1,0,0, 0,1,0,1,0, 0,0,1,0,0],
  love:      [0,1,0,1,0, 1,1,1,1,1, 1,1,1,1,1, 0,1,1,1,0, 0,0,1,0,0],
  sleepy:    [0,0,0,0,0, 0,0,0,0,0, 1,1,0,1,1, 0,0,0,0,0, 0,1,1,1,0],
  silly:     [0,1,0,1,0, 0,0,0,0,0, 1,1,1,1,1, 0,0,0,0,1, 0,1,1,1,0],
  crazy:     [1,0,0,0,1, 0,1,0,1,0, 0,0,1,0,0, 0,1,0,1,0, 1,0,0,0,1],
  dizzy:     [0,1,0,1,0, 1,0,0,0,1, 0,0,1,0,0, 1,0,0,0,1, 0,1,0,1,0],
  wink:      [0,0,1,0,0, 0,1,0,1,0, 0,0,0,0,0, 1,0,0,0,1, 0,1,1,1,0],
  cool:      [1,1,1,1,1, 1,0,1,0,1, 0,0,0,0,0, 1,0,0,0,1, 0,1,1,1,0],
  wow:       [0,1,0,1,0, 0,0,0,0,0, 0,0,1,0,0, 0,1,0,1,0, 0,0,1,0,0],
  oops:      [0,1,0,1,0, 0,0,0,0,0, 0,0,0,0,0, 0,1,1,1,0, 0,0,0,0,0],
  haha:      [0,1,0,1,0, 0,0,0,0,0, 1,1,1,1,1, 1,0,0,0,1, 0,1,1,1,0],
  cry:       [0,1,0,1,0, 0,0,0,0,0, 0,0,0,0,0, 0,1,1,1,0, 1,0,0,0,1],
  
  // Animals
  cat:       [0,1,0,1,0, 1,0,1,0,1, 0,0,0,0,0, 0,1,0,1,0, 0,0,1,0,0],
  dog:       [0,1,0,1,0, 0,0,0,0,0, 0,0,1,0,0, 0,1,1,1,0, 0,1,0,1,0],
  duck:      [1,1,0,0,0, 1,1,1,0,0, 0,1,1,0,0, 0,0,1,1,1, 0,0,0,1,1],
  cow:       [1,0,0,0,1, 0,1,1,1,0, 0,1,1,1,0, 0,0,1,0,0, 0,1,0,1,0],
  pig:       [0,1,1,1,0, 1,0,1,0,1, 0,1,1,1,0, 0,0,1,0,0, 0,1,0,1,0],
  frog:      [1,0,0,0,1, 0,1,0,1,0, 1,1,1,1,1, 1,0,0,0,1, 0,1,1,1,0],
  snake:     [0,0,1,1,0, 0,1,0,0,1, 0,1,0,0,1, 0,1,1,1,0, 0,0,0,0,0],
  monkey:    [0,1,1,1,0, 1,0,1,0,1, 0,1,1,1,0, 0,1,1,1,0, 0,0,1,0,0],
  
  // Actions
  wave:      [0,0,0,1,0, 0,0,0,1,0, 0,0,0,1,0, 0,0,1,0,0, 0,1,0,0,0],
  dance:     [0,1,0,1,0, 0,0,0,0,0, 0,1,1,1,0, 0,1,0,1,0, 1,0,0,0,1],
  spin:      [0,0,1,0,0, 0,1,1,1,0, 1,1,0,1,1, 0,1,1,1,0, 0,0,1,0,0],
  jump:      [0,0,1,0,0, 0,1,1,1,0, 1,0,1,0,1, 0,0,1,0,0, 0,1,0,1,0],
  blink:     [0,0,0,0,0, 1,1,0,1,1, 0,0,0,0,0, 1,0,0,0,1, 0,1,1,1,0],
  nod:       [0,0,0,0,0, 0,1,0,1,0, 0,0,0,0,0, 0,0,0,0,0, 0,1,1,1,0],
  no:        [1,0,0,0,1, 0,1,0,1,0, 0,0,1,0,0, 0,1,0,1,0, 1,0,0,0,1],
  wiggle:    [0,1,0,1,0, 0,0,0,0,0, 1,1,1,1,1, 0,1,0,1,0, 1,0,0,0,1],
  bounce:    [0,0,1,0,0, 0,1,1,1,0, 0,0,1,0,0, 0,0,0,0,0, 0,0,0,0,0],
  yawn:      [0,0,0,0,0, 0,1,0,1,0, 0,0,0,0,0, 0,1,1,1,0, 0,1,1,1,0],
  
  // Party
  party:     [1,0,1,0,1, 0,1,0,1,0, 1,0,1,0,1, 0,1,0,1,0, 1,0,1,0,1],
  disco:     [1,1,1,1,1, 1,0,0,0,1, 1,0,0,0,1, 1,0,0,0,1, 1,1,1,1,1],
  rainbow:   [1,1,1,1,1, 1,0,0,0,0, 0,1,0,0,0, 0,0,1,0,0, 0,0,0,1,1],
  fireworks: [0,0,1,0,0, 0,1,0,1,0, 1,0,0,0,1, 0,1,0,1,0, 0,0,1,0,0],
  confetti:  [1,0,0,1,0, 0,0,1,0,1, 1,0,0,0,0, 0,1,0,1,0, 0,0,1,0,1],
  yay:       [1,0,0,0,1, 1,0,0,0,1, 0,0,0,0,0, 0,0,0,0,0, 0,1,1,1,0],
  
  // Powers
  laser:     [0,0,0,0,1, 0,0,0,1,0, 1,0,1,0,0, 0,1,0,0,0, 1,0,0,0,0],
  freeze:    [0,0,1,0,0, 0,1,1,1,0, 1,1,1,1,1, 0,1,1,1,0, 0,0,1,0,0],
  fire:      [0,0,1,0,0, 0,1,1,1,0, 0,1,1,1,0, 1,1,1,1,1, 1,1,1,1,1],
  magic:     [0,0,1,0,0, 0,1,0,1,0, 1,0,0,0,1, 0,1,0,1,0, 0,0,1,0,0],
  rocket:    [0,0,1,0,0, 0,1,1,1,0, 0,1,1,1,0, 1,0,1,0,1, 0,0,1,0,0],
  explode:   [1,0,0,0,1, 0,1,0,1,0, 0,0,1,0,0, 0,1,0,1,0, 1,0,0,0,1],
  thunder:   [0,0,1,1,0, 0,1,1,0,0, 0,0,1,0,0, 0,1,0,0,0, 0,1,0,0,0],
  
  // Sounds
  fart:      [0,0,0,0,0, 0,0,0,0,0, 0,1,1,1,0, 1,0,0,0,1, 0,1,1,1,0],
  burp:      [0,0,0,0,0, 0,1,0,1,0, 0,0,0,0,0, 1,1,1,1,1, 0,0,0,0,0],
  beep:      [0,0,0,0,0, 0,0,1,0,0, 0,1,1,1,0, 0,0,1,0,0, 0,0,0,0,0],
  laugh:     [0,1,0,1,0, 0,0,0,0,0, 1,1,1,1,1, 0,0,0,0,0, 0,1,1,1,0],
  horn:      [0,0,0,1,1, 0,0,1,1,1, 0,1,1,1,1, 0,0,1,1,1, 0,0,0,1,1],
  
  // States
  thinking:  [0,0,0,0,0, 0,1,0,1,0, 0,0,0,0,0, 0,0,0,1,0, 0,0,1,0,0],
  speaking:  [0,1,0,1,0, 0,0,0,0,0, 0,0,0,0,0, 0,1,1,1,0, 0,0,0,0,0],
  listening: [0,1,0,1,0, 0,0,0,0,0, 0,0,0,0,0, 1,0,0,0,1, 0,1,1,1,0],
};

// Personality LED animations (UI only). Commands override briefly.
let ledAnimTimer = null;
let ledAnimPausedUntil = 0;
let ledAnimFrame = 0;

const LED_ANIM = {
  playful: ['happy','wink','party','dance','wow'],
  helpful: ['happy','listening','speaking','thinking','cool'],
  pirate:  ['wink','angry','horn','laugh','cool'],
  space:   ['rocket','wow','thunder','speaking','happy']
};

function renderLEDPixels(pattern) {
  ledGrid.querySelectorAll('.led-pixel').forEach((px, i) => px.classList.toggle('on', pattern[i] === 1));
}

function startPersonalityLEDAnimation(force = false) {
  if (ledAnimTimer && !force) return;
  stopPersonalityLEDAnimation();
  ledAnimFrame = 0;
  ledAnimTimer = setInterval(() => {
    if (Date.now() < ledAnimPausedUntil) return;
    const seq = LED_ANIM[state.personality] || LED_ANIM.helpful;
    const key = seq[ledAnimFrame % seq.length] || 'happy';
    renderLEDPixels(LED[key] || LED.happy);
    ledAnimFrame++;
  }, 450);
}

function stopPersonalityLEDAnimation() {
  if (ledAnimTimer) clearInterval(ledAnimTimer);
  ledAnimTimer = null;
}

function updateLED(cmd) {
  //  Browser never draws LEDs when connected
  if (state.ledFromMicrobitOnly) return;

  const key = cmd.toLowerCase().replace(/[^a-z]/g, '');
  const p = LED[key] || LED.happy;
  ledAnimPausedUntil = Date.now() + 2000;
  renderLEDPixels(p);
}

// ==================== MODALS & PANELS ====================
function openModal(id) { $(id).classList.add('open'); document.body.style.overflow = 'hidden'; }
function closeModal(id) { $(id).classList.remove('open'); document.body.style.overflow = ''; }
function toggleSidebar() { sidebar.classList.toggle('open'); overlay.classList.toggle('show', sidebar.classList.contains('open')); }
function toggleLogs() { 
  logsPanel.classList.toggle('open'); 
  document.body.classList.toggle('logs-open', logsPanel.classList.contains('open'));
  $('logsBtn').classList.toggle('active', logsPanel.classList.contains('open')); 
}
function toggleCommands() {
  const panel = $('commandsPanel');
  panel.classList.toggle('open');
  document.body.classList.toggle('commands-open', panel.classList.contains('open'));
  $('commandsBtn').classList.toggle('active', panel.classList.contains('open'));
}
function closeAllPanels() { 
  sidebar.classList.remove('open'); 
  logsPanel.classList.remove('open'); 
  $('commandsPanel').classList.remove('open');
  document.body.classList.remove('logs-open');
  document.body.classList.remove('commands-open');
  overlay.classList.remove('show'); 
  $('logsBtn').classList.remove('active');
  $('commandsBtn').classList.remove('active');
  document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open')); 
  document.body.style.overflow = ''; 
}

function generateCommands() {
  const body = $('commandsBody');
  body.innerHTML = '<p style="color:var(--muted);margin-bottom:12px;font-size:0.8rem">Tap any command to try it!</p>';
  for (const [key, cat] of Object.entries(COMMANDS)) {
    const div = document.createElement('div');
    div.className = 'command-category';
    div.innerHTML = `<div class="category-header"><span>${cat.icon}</span> ${cat.name}</div><div class="category-commands">${cat.items.map(c => `<button class="command-chip" onclick="tryCmd('${c}')">[${c}]</button>`).join('')}</div>`;
    body.appendChild(div);
  }
}

function tryCmd(cmd) {
  // Don't close panel - let user try multiple commands
  addChat(`Show me ${cmd}!`, 'user');
  addChat(`Here's ${cmd}!`, 'robot');
  sendToMicrobit(cmd); updateLED(cmd);
  speak(`Here's ${cmd}!`);
}

// ==================== LOGGING ====================
let logCounts = { total: 0, tx: 0, rx: 0, error: 0 };

function log(msg, type = 'info') {
  // Remove empty message if exists
  const empty = logsContent.querySelector('.logs-empty');
  if (empty) empty.remove();
  
  const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const entry = document.createElement('div');
  entry.className = 'log-entry ' + type;
  entry.dataset.time = new Date().toISOString();
  entry.dataset.type = type;
  
  let tag = '';
  if (type === 'tx') tag = '<span class="log-tag ble">TX</span>';
  else if (type === 'rx') tag = '<span class="log-tag ble">RX</span>';
  else if (type === 'ble') tag = '<span class="log-tag ble">BLE</span>';
  else if (type === 'speech') tag = '<span class="log-tag speech">SPEECH</span>';
  else if (type === 'ai') tag = '<span class="log-tag ai">AI</span>';
  else if (type === 'error') tag = '<span class="log-tag error">ERROR</span>';
  
  entry.innerHTML = `<span style="opacity:0.6">[${ts}]</span> ${tag} ${escapeHtml(msg)}`;
  logsContent.appendChild(entry);
  logsContent.scrollTop = logsContent.scrollHeight;
  
  // Update counts
  logCounts.total++;
  if (type === 'tx') logCounts.tx++;
  if (type === 'rx') logCounts.rx++;
  if (type === 'error') logCounts.error++;
  updateLogStats();
  
  // Keep max 500 entries
  while (logsContent.querySelectorAll('.log-entry').length > 500) {
    const first = logsContent.querySelector('.log-entry');
    if (first) first.remove();
  }
  
  console.log(`[${type}] ${msg}`);
}

function updateLogStats() {
  $('logCount').textContent = logCounts.total;
  $('logCountTx').textContent = logCounts.tx;
  $('logCountRx').textContent = logCounts.rx;
  $('logCountErr').textContent = logCounts.error;
}

function clearLogs() {
  logsContent.innerHTML = '<div class="logs-empty">Logs cleared. Start chatting!</div>';
  logCounts = { total: 0, tx: 0, rx: 0, error: 0 };
  updateLogStats();
}

function filterLogs(filter) {
  // Update button states
  document.querySelectorAll('.logs-filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.filter === filter);
  });
  
  // Remove all filter classes
  logsContent.classList.remove('filtered-tx', 'filtered-rx', 'filtered-error', 'filtered-ai', 'filtered-ble', 'filtered-speech');
  
  // Apply filter
  if (filter !== 'all') {
    logsContent.classList.add('filtered-' + filter);
  }
}

function exportLogs() {
  const entries = logsContent.querySelectorAll('.log-entry');
  if (entries.length === 0) {
    alert('No logs to export');
    return;
  }
  
  let text = '# Talking Robot V2 - Debug Logs\n';
  text += '# Exported: ' + new Date().toISOString() + '\n';
  text += '# Total entries: ' + entries.length + '\n\n';
  
  entries.forEach(entry => {
    const time = entry.dataset.time || '';
    const type = entry.dataset.type || 'info';
    const msg = entry.textContent.replace(/^\[[\d:]+\]\s*/, '').replace(/^(TX|RX|BLE|SPEECH|AI|ERROR)\s*/, '');
    text += `[${time}] [${type.toUpperCase()}] ${msg}\n`;
  });
  
  // Download file
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'talking-robot-logs-' + new Date().toISOString().slice(0,19).replace(/[:.]/g, '-') + '.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  log('Logs exported (' + entries.length + ' entries)', 'success');
}

// Resize functionality
function setupLogsResize() {
  const handle = $('logsResizeHandle');
  let isResizing = false;
  let startX, startWidth;
  
  handle.addEventListener('mousedown', (e) => {
    isResizing = true;
    startX = e.clientX;
    startWidth = logsPanel.offsetWidth;
    logsPanel.classList.add('resizing');
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    e.preventDefault();
  });
  
  function handleMouseMove(e) {
    if (!isResizing) return;
    const diff = startX - e.clientX;
    const newWidth = Math.min(Math.max(startWidth + diff, 280), window.innerWidth * 0.9);
    logsPanel.style.width = newWidth + 'px';
  }
  
  function handleMouseUp() {
    isResizing = false;
    logsPanel.classList.remove('resizing');
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
  }
  
  // Touch support
  handle.addEventListener('touchstart', (e) => {
    isResizing = true;
    startX = e.touches[0].clientX;
    startWidth = logsPanel.offsetWidth;
    logsPanel.classList.add('resizing');
  });
  
  document.addEventListener('touchmove', (e) => {
    if (!isResizing) return;
    const diff = startX - e.touches[0].clientX;
    const newWidth = Math.min(Math.max(startWidth + diff, 280), window.innerWidth * 0.9);
    logsPanel.style.width = newWidth + 'px';
  });
  
  document.addEventListener('touchend', () => {
    if (isResizing) {
      isResizing = false;
      logsPanel.classList.remove('resizing');
    }
  });
}

// ==================== UTILS ====================
function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function clearAllData() { if (confirm('Reset all settings and clear data?')) { localStorage.removeItem('talkingRobotV2'); location.reload(); } }

// Sidebar resize functionality
function setupSidebarResize() {
  const handle = $('sidebarResizeHandle');
  let isResizing = false;
  let startX, startWidth;
  
  handle.addEventListener('mousedown', (e) => {
    isResizing = true;
    startX = e.clientX;
    startWidth = sidebar.offsetWidth;
    sidebar.classList.add('resizing');
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    e.preventDefault();
  });
  
  function handleMouseMove(e) {
    if (!isResizing) return;
    const diff = startX - e.clientX;
    const newWidth = Math.min(Math.max(startWidth + diff, 280), window.innerWidth * 0.9);
    sidebar.style.width = newWidth + 'px';
  }
  
  function handleMouseUp() {
    isResizing = false;
    sidebar.classList.remove('resizing');
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
  }
  
  // Touch support
  handle.addEventListener('touchstart', (e) => {
    isResizing = true;
    startX = e.touches[0].clientX;
    startWidth = sidebar.offsetWidth;
    sidebar.classList.add('resizing');
  });
  
  document.addEventListener('touchmove', (e) => {
    if (!isResizing) return;
    const diff = startX - e.touches[0].clientX;
    const newWidth = Math.min(Math.max(startWidth + diff, 280), window.innerWidth * 0.9);
    sidebar.style.width = newWidth + 'px';
  });
  
  document.addEventListener('touchend', () => {
    if (isResizing) {
      isResizing = false;
      sidebar.classList.remove('resizing');
    }
  });
}

// ==================== START ====================
setupLogsResize();
setupSidebarResize();
init();
</script>
</body>
</html>
